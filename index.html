<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>Penedex Map</title>
  <script src="https://cdn.apple-mapkit.com/mk/5.x.x/mapkit.js"></script>
  <style>
	body, html {
	  margin: 0;
	  padding: 0;
	  height: 100%;
	}
	#map {
	  width: 100%;
	  height: 100vh;
	}
  </style>
</head>
<body>
  <div id="map"></div>

  <script>
	// Initialize MapKit
	mapkit.init({
	  authorizationCallback: function(done) {
		fetch('/api/token')
		  .then(response => response.text())
		  .then(token => done(token))
		  .catch(error => {
			console.error("Failed to load MapKit token:", error);
		  });
	  }
	});

	const map = new mapkit.Map("map");

	async function loadLocations() {
	  try {
		const response = await fetch('/api/locations');
		const result = await response.json();

		if (!result.records) {
		  console.error("No records found:", result);
		  return;
		}

		for (const record of result.records) {
		  const location = record.fields.location.value;
		  const name = record.fields.name ? record.fields.name.value : "Untitled";

		  const annotation = new mapkit.MarkerAnnotation(
			new mapkit.Coordinate(location.latitude, location.longitude),
			{ title: name }
		  );
		  map.addAnnotation(annotation);
		}
	  } catch (error) {
		console.error("Error loading locations:", error);
	  }
	}

	loadLocations();
  </script>
</body>
</html>
